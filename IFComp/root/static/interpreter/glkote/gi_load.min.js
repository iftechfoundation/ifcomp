var GiLoad=function(){var e,r,t={vm:null,io:null,spacing:4,use_query_story:!0,default_story:null,set_page_title:!0,default_page_title:"Game",game_format_name:"",exit_warning:"The game session has ended.",image_info_map:null,proxy_url:"https://zcode.appspot.com/proxy/"},a=null,i={},o=null,n={},l={};function f(e){if(e.match(/^(file|data|http|https):/i))return e;var r=document.createElement("div");return r.innerHTML="<a></a>",r.firstChild.href=e,r.innerHTML=r.innerHTML,r.firstChild.href}function d(e){if(null!=t.image_info_map&&(a=t.image_info_map[e]))return a;var r=n["Pict:"+e];if(r){var a={image:e};if("JPEG"==r.type?a.type="jpeg":"PNG "==r.type?a.type="png":a.type="????",void 0===r.imagesize){var i=void 0;"JPEG"==r.type?i=function(e){var r=0;for(;r<e.length;){if(255!=e[r])return void GlkOte.log("find_dimensions_jpeg: marker is not 0xFF");for(;255==e[r];)r+=1;var t=e[r];if(r+=1,!(1==t||t>=208&&t<=217)){var a=e[r+0]<<8|e[r+1];if(t>=192&&t<=207&&200!=t){if(a<7)return void GlkOte.log("find_dimensions_jpeg: SOF block is too small");var i={};return i.height=e[r+3]<<8|e[r+4],i.width=e[r+5]<<8|e[r+6],i}r+=a}}return void GlkOte.log("find_dimensions_jpeg: no SOF marker found")}(r.content):"PNG "==r.type&&(i=function(e){var r=0;if(137!=e[0]||"PNG"!=String.fromCharCode.apply(this,e.slice(1,4)))return void GlkOte.log("find_dimensions_png: PNG signature does not match");r+=8;for(;r<e.length;){var t=e[r+0]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3];r+=4;var a=String.fromCharCode.apply(this,e.slice(r,r+4));if(r+=4,"IHDR"==a){var i={};return i.width=e[r+0]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3],r+=4,i.height=e[r+0]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3],r+=4,i}r+=t,r+=4}return void GlkOte.log("find_dimensions_png: no PNG header block found")}(r.content)),i&&(r.imagesize=i)}r.imagesize&&(a.width=r.imagesize.width,a.height=r.imagesize.height);var o=l["Pict:"+e];return o&&(a.alttext=o),a}}function s(e){for(var r,t=[],a=0;a<e.length;){var i,o,n,l;if(a>=e.length)break;if(i=e[a],a++,i<128)r=i;else{if(a>=e.length)break;if(o=e[a],a++,128!=(192&o))break;if(192==(224&i))r=(31&i)<<6,r|=63&o;else{if(a>=e.length)break;if(n=e[a],a++,128!=(192&n))break;if(224==(240&i))r=(15&i)<<12&61440,r|=(63&o)<<6&4032,r|=63&n;else{if(240!=(240&i))break;if(a>=e.length)break;if(l=e[a],a++,128!=(192&l))break;r=(7&i)<<18&1835008,r|=(63&o)<<12&258048,r|=(63&n)<<6&4032,r|=63&l}}}t.push(r)}return String.fromCharCode.apply(this,t)}if(window.atob)r=function(e){var r,t=atob(e),a=Array(t.length);for(r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return a};else{var u=function(){var e,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=[];for(e=0;e<r.length;e++)t[r.charAt(e)]=e;return t}();r=function(e){for(var r,t,a,i,o,n,l=[],f=0,d=e.length;f<d;)r=(u[e.charAt(f++)]<<2)+((i=u[e.charAt(f++)])>>4),t=((15&i)<<4)+((o=u[e.charAt(f++)])>>2),a=((3&o)<<6)+(n=u[e.charAt(f++)]),l.push(r,t,a);return 64==n&&l.pop(),64==o&&l.pop(),l}}function c(e){if(0!=e.length){if(70==e[0]&&79==e[1]&&82==e[2]&&77==e[3]){var r=String.fromCharCode(e[8],e[9],e[10],e[11]);if("IFZS"==r)return void t.io.fatal_error("This is a saved-game file, not a "+t.game_format_name+" game file. You must launch the game first, then restore your save.");if("IFRS"!=r)return void t.io.fatal_error("This IFF file is not a Blorb file!");if(t.blorb_gamechunk_type)try{e=function(e,r){for(var a,f=e.length,d=[],u=null,c=12;c<f;){var g=String.fromCharCode(e[c+0],e[c+1],e[c+2],e[c+3]),p=e[(c+=4)+0]<<24|e[c+1]<<16|e[c+2]<<8|e[c+3];if(c+=4,"RIdx"==g){var h=e[(w=c)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];for(w+=4,a=0;a<h;a++){var m=String.fromCharCode(e[w+0],e[w+1],e[w+2],e[w+3]),_=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3],v=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];w+=4,d.push({usage:m,num:_,pos:v})}}if("IFmd"==g){var y=s(G=e.slice(c,c+p)),b=$("<metadata>").html(y).find("bibliographic").children();if(b.length)for(a=0;a<b.length;a++)T=b[a],i[T.tagName.toLowerCase()]=T.textContent}if("Dbug"==g&&t.debug_info_chunk){var G=e.slice(c,c+p);o=G}if("RDes"==g){var w,k=e[(w=c)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];for(w+=4,a=0;a<k;a++){var x=String.fromCharCode.apply(this,e.slice(w,w+4)),C=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3],j=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];w+=4;var O=s(e.slice(w,w+j));w+=j,l[x+":"+C]=O}}1&(c+=p)&&c++}for(a=0;a<d.length;a++){var T;c=(T=d[a]).pos;g=String.fromCharCode(e[c+0],e[c+1],e[c+2],e[c+3]),p=e[(c+=4)+0]<<24|e[c+1]<<16|e[c+2]<<8|e[c+3];c+=4,T.type=g,T.len=p,T.content=null,"Exec"==T.usage&&0==T.num&&g==r?u=e.slice(c,c+p):(T.content="FORM"==g?e.slice(c-8,c+p):e.slice(c,c+p),n[T.usage+":"+T.num]=T)}return u}(e,t.blorb_gamechunk_type)}catch(e){return void t.io.fatal_error("Blorb file could not be parsed: "+e)}if(!e)return void t.io.fatal_error("Blorb file contains no "+t.game_format_name+" game!")}var f=null;i&&(f=i.title),!f&&a&&(f=a.slice(a.lastIndexOf("/")+1)),f||(f=t.default_page_title),f||(f="Game"),t.recording_label||(t.recording_label=f),t.set_page_title&&(document.title=f+" - "+t.engine_name),t.vm.prepare(e,t),t.io.init(t)}else t.io.fatal_error("No game file was loaded. (Zero-length response.)")}return e=window.btoa?function(e){for(var r=[],t=e.length,a=0;a<t;a+=16384)r.push(String.fromCharCode.apply(String,e.slice(a,a+16384)));return btoa(r.join(""))}:function(e){for(var r,t,a,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=[],n=0;n<e.length;n+=3)r=e[n],t=e[n+1],a=e[n+2],o.push(i.charAt(r>>2&63)),o.push(i.charAt(r<<4&48|t>>4&15)),o.push(i.charAt(t<<2&60|a>>6&3)),o.push(i.charAt(63&a));return void 0===t&&o.length>=2&&(o[o.length-2]="="),void 0===a&&o.length>=1&&(o[o.length-1]="="),o.join("")},{load_run:function(e,i,o){o?"string"==typeof o&&(o={format:o}):o={};var n=o.format;if(n||(n="array"),t.io=window.Glk,t.vm=window.Quixe,e||(e=window.game_options),!e||!window.Quixe||e.vm&&e.vm!==window.Quixe||(t.engine_name="Quixe",t.blorb_gamechunk_type="GLUL",t.game_format_name="Glulx"),e&&jQuery.extend(t,e),null!=t.image_info_map&&"string"===jQuery.type(t.image_info_map)&&(window[t.image_info_map]?t.image_info_map=window[t.image_info_map]:delete t.image_info_map),a=null,t.use_query_story){var l=function(){var e={},r=location.search.substring(1,location.search.length);if(r.length){var t=r.split("&");r=r.replace(/\+/g," ");for(var a=0;a<t.length;a++){var i=t[a].split("="),o=decodeURIComponent(i[0]),n=2==i.length?decodeURIComponent(i[1]):o;e[o]=n}}return e}();a=l.story}if(a||!i)if(a||(a=t.default_story),a){i=null;var d=new XMLHttpRequest,s=void 0!==d.overrideMimeType,u=void 0!==d.withCredentials;d=null;var g=/^(file:|(\w+:)?\/\/[^\/?#]+)/,p=g.exec(location)[0],h=g.exec(a),m=!h,_=h?h[0]:p,v=p==_;navigator.userAgent.match(/chrome/i)&&"file:"==_&&(v=!1);var y=a.match(/[.]js$/i);if(GlkOte.log("GiLoad: is_relative="+m+", same_origin="+v+", binary_supported="+s+", crossorigin_supported="+u),y&&v)return GlkOte.log("GiLoad: trying old-fashioned load..."),window.processBase64Zcode=function(e){c(r(e))},void jQuery.ajax(a,{type:"GET",dataType:"script",cache:!0,error:function(e,r,i){t.io.fatal_error("The story could not be loaded. ("+a+"): Error "+r+": "+i)}});if(y){if(GlkOte.log("GiLoad: trying script load..."),window.processBase64Zcode=function(e){c(r(e))},!(w=$("head")).length)return void t.io.fatal_error("This page has no <head> element!");var b=$("<script>",{src:a,type:"text/javascript"});w.get(0).appendChild(b.get(0))}else{if(s&&v)return GlkOte.log("GiLoad: trying binary load..."),void jQuery.ajax(a,{type:"GET",beforeSend:function(e,r){e.overrideMimeType("text/plain; charset=x-user-defined")},success:function(e,r,t){c(function(e){var r,t=Array(e.length);for(r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t}(e))},error:function(e,r,i){t.io.fatal_error("The story could not be loaded. ("+a+"): Error "+r+": "+i)}});if("file:"!=_){var G=a;if(m&&(G=f(a),GlkOte.log("GiLoad: absolutize "+a+" to "+G)),u)return GlkOte.log("GiLoad: trying proxy load... ("+t.proxy_url+")"),void jQuery.ajax(t.proxy_url,{type:"GET",data:{encode:"base64",url:G},error:function(e,r,i){t.io.fatal_error("The story could not be loaded. ("+a+"): Error "+r+": "+i)},success:function(e,t,a){c(r(e))}});var w,k=t.proxy_url+"?encode=base64&callback=processBase64Zcode&url="+G;if(GlkOte.log("GiLoad: trying proxy-script load... ("+k+")"),window.processBase64Zcode=function(e){c(r(e))},(w=$("head")).length){b=$("<script>",{src:k,type:"text/javascript"});w.append(b)}else t.io.fatal_error("This page has no <head> element!")}else t.io.fatal_error("The story could not be loaded. ("+a+"): A local file cannot be sent to the proxy.")}}else t.io.fatal_error("No story file specified!");else{switch(GlkOte.log("GiLoad: trying pre-loaded load ("+n+")..."),n){case"base64":i=r(i);break;case"raw":i=decode_text(i);break;case"array":break;default:return void t.io.fatal_error("Could not decode story file data: "+n)}c(i)}},find_data_chunk:function(e){var r=n["Data:"+e];if(!r)return null;var t=r.type;return"FORM"==t&&(t="BINA"),{data:r.content,type:t}},get_metadata:function(e){return i[e]},get_debug_info:function(){return o},get_image_info:d,get_image_url:function(r){if(t.image_info_map){var a=t.image_info_map[r];if(a&&a.url)return f(a.url)}var i=n["Pict:"+r];if(i){if(i.dataurl)return i.dataurl;if(d(r)&&i.content){var o="application/octet-stream";"JPEG"==i.type?o="image/jpeg":"PNG "==i.type&&(o="image/png");var l=e(i.content);return i.dataurl="data:"+o+";base64,"+l,i.dataurl}}}}}();